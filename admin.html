<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkmate Admin - 活動管理</title>
    <link rel="stylesheet" href="css/token.css" />
    <link rel="stylesheet" href="css/admin.css" />
  </head>
  <body>
    <div id="admin-root">
      <div class="admin-container">
        <div class="admin-sidebar">
          <div class="admin-header">
            <h1>Checkmate 管理</h1>
            <button class="publish-btn" id="publish-btn">發布</button>
          </div>
          
          <div class="links-section">
            <h3>分享連結</h3>
            <div class="link-item">
              <div class="link-info">
                <strong>用戶連結</strong><br>
                <small>給團隊成員使用</small>
              </div>
              <button class="copy-btn" onclick="copyUserLink()">複製</button>
            </div>
            <div class="link-item">
              <div class="link-info">
                <strong>管理連結</strong><br>
                <small>編輯後台</small>
              </div>
              <button class="copy-btn" onclick="copyAdminLink()">複製</button>
            </div>
          </div>
          
          <div class="section-list">
            <div class="section-item" data-section="title">
              <div class="section-info">
                <span class="section-icon">📝</span>
                <span class="section-name">標題設定</span>
              </div>
              <span class="section-toggle">👁️</span>
            </div>
            <div class="section-item" data-section="countdown">
              <div class="section-info">
                <span class="section-icon">⏰</span>
                <span class="section-name">倒數計時</span>
              </div>
              <span class="section-toggle">👁️</span>
            </div>
            <div class="section-item" data-section="schedule">
              <div class="section-info">
                <span class="section-icon">📅</span>
                <span class="section-name">行程安排</span>
              </div>
              <span class="section-toggle">👁️</span>
            </div>
            <div class="section-item" data-section="packing">
              <div class="section-info">
                <span class="section-icon">📦</span>
                <span class="section-name">打包清單</span>
              </div>
              <span class="section-toggle">👁️</span>
            </div>
          </div>
        </div>
        
        <div class="admin-preview">
          <h2>預覽</h2>
          <div class="preview-phone">
            <div class="preview-content">
              <div class="preview-header">
                <h1 id="preview-title">Trip</h1>
                <div id="preview-subtitle">2025</div>
              </div>
              
              <div class="preview-countdown">
                <div class="countdown-date" id="preview-date">March 15th-16th, 2025</div>
                <div class="countdown-numbers">
                  <div class="countdown-item">
                    <div class="number">03</div>
                    <div class="label">Days</div>
                  </div>
                  <div class="countdown-item">
                    <div class="number">13</div>
                    <div class="label">Hours</div>
                  </div>
                  <div class="countdown-item">
                    <div class="number">30</div>
                    <div class="label">Minutes</div>
                  </div>
                  <div class="countdown-item">
                    <div class="number">58</div>
                    <div class="label">Seconds</div>
                  </div>
                </div>
              </div>
              
              <div class="preview-schedule">
                <h3>Schedule</h3>
                <div id="schedule-preview">
                  <div class="empty-state">No Schedule yet</div>
                </div>
              </div>
              
              <div class="preview-packing">
                <h3>Packing list</h3>
                <div id="packing-preview">
                  <div class="empty-state">No items yet</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-overlay" id="modal-overlay" style="display: none;">
        <div class="modal-content" id="modal-content"></div>
      </div>
    </div>

    <script type="module" src="js/firebase-config.js"></script>
    <script>
      let appSettings = {
        title: "Trip",
        subtitle: "2025",
        dateFrom: "2025-03-15T11:30",
        dateTo: "2025-03-16T15:00",
        schedule: []
      };

      const roomId = new URLSearchParams(window.location.search).get('room') || 'demo-room-' + Date.now();

      // 初始化
      document.addEventListener('DOMContentLoaded', function() {
        setupEventListeners();
        updatePreview();
      });

      function setupEventListeners() {
        // 區塊點擊事件
        document.addEventListener('click', function(e) {
          if (e.target.closest('.section-item')) {
            const section = e.target.closest('.section-item').dataset.section;
            openModal(section);
          }
          
          if (e.target.matches('.modal-overlay') || e.target.matches('.modal-close')) {
            closeModal();
          }
        });

        // 發布按鈕
        document.getElementById('publish-btn').addEventListener('click', publishChanges);
      }

      function openModal(section) {
        const modal = document.getElementById('modal-overlay');
        const content = document.getElementById('modal-content');
        
        content.innerHTML = getModalContent(section);
        modal.style.display = 'flex';
        
        bindModalEvents(section);
      }

      function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
      }

      function getModalContent(section) {
        switch(section) {
          case 'title':
            return `
              <div class="modal-header">
                <h3>標題設定</h3>
                <button class="modal-close">×</button>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label>主標題</label>
                  <input type="text" id="title-input" value="${appSettings.title}" placeholder="輸入主標題">
                </div>
                <div class="form-group">
                  <label>副標題</label>
                  <input type="text" id="subtitle-input" value="${appSettings.subtitle}" placeholder="輸入副標題">
                </div>
              </div>
              <div class="modal-footer">
                <button class="save-btn" onclick="saveTitleSettings()">儲存</button>
              </div>
            `;
            
          case 'countdown':
            return `
              <div class="modal-header">
                <h3>倒數計時設定</h3>
                <button class="modal-close">×</button>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label>開始時間</label>
                  <input type="datetime-local" id="date-from" value="${appSettings.dateFrom}">
                </div>
                <div class="form-group">
                  <label>結束時間</label>
                  <input type="datetime-local" id="date-to" value="${appSettings.dateTo}">
                </div>
              </div>
              <div class="modal-footer">
                <button class="save-btn" onclick="saveDateSettings()">儲存</button>
              </div>
            `;
            
          case 'schedule':
            return `
              <div class="modal-header">
                <h3>行程設定</h3>
                <button class="modal-close">×</button>
              </div>
              <div class="modal-body">
                <div id="schedule-list">
                  ${appSettings.schedule.map((item, index) => `
                    <div class="schedule-row">
                      <input type="time" value="${item.time}" data-index="${index}" data-field="time">
                      <input type="text" value="${item.activity}" data-index="${index}" data-field="activity" placeholder="活動">
                      <button class="remove-btn" onclick="removeScheduleItem(${index})">×</button>
                    </div>
                  `).join('')}
                </div>
                <button class="add-schedule-btn" onclick="addScheduleItem()">+ 新增行程</button>
              </div>
              <div class="modal-footer">
                <button class="save-btn" onclick="saveScheduleSettings()">儲存</button>
              </div>
            `;
            
          default:
            return `
              <div class="modal-header">
                <h3>${section}</h3>
                <button class="modal-close">×</button>
              </div>
              <div class="modal-body">
                <p>功能開發中...</p>
              </div>
            `;
        }
      }

      function bindModalEvents(section) {
        if (section === 'schedule') {
          document.addEventListener('input', function(e) {
            if (e.target.matches('input[data-index]')) {
              const index = parseInt(e.target.dataset.index);
              const field = e.target.dataset.field;
              if (appSettings.schedule[index]) {
                appSettings.schedule[index][field] = e.target.value;
              }
            }
          });
        }
      }

      function saveTitleSettings() {
        appSettings.title = document.getElementById('title-input').value;
        appSettings.subtitle = document.getElementById('subtitle-input').value;
        updatePreview();
        closeModal();
        showNotification('標題已更新');
      }

      function saveDateSettings() {
        appSettings.dateFrom = document.getElementById('date-from').value;
        appSettings.dateTo = document.getElementById('date-to').value;
        updatePreview();
        closeModal();
        showNotification('日期已更新');
      }

      function saveScheduleSettings() {
        updatePreview();
        closeModal();
        showNotification('行程已更新');
      }

      function addScheduleItem() {
        appSettings.schedule.push({ time: '16:00', activity: '新活動' });
        const content = document.getElementById('modal-content');
        content.innerHTML = getModalContent('schedule');
        bindModalEvents('schedule');
      }

      function removeScheduleItem(index) {
        appSettings.schedule.splice(index, 1);
        const content = document.getElementById('modal-content');
        content.innerHTML = getModalContent('schedule');
        bindModalEvents('schedule');
      }

      function updatePreview() {
        // 更新標題
        document.getElementById('preview-title').textContent = appSettings.title;
        document.getElementById('preview-subtitle').textContent = appSettings.subtitle;
        
        // 更新日期顯示
        if (appSettings.dateFrom) {
          const fromDate = new Date(appSettings.dateFrom);
          const toDate = new Date(appSettings.dateTo);
          const isSameDay = fromDate.toDateString() === toDate.toDateString();
          
          if (isSameDay) {
            document.getElementById('preview-date').textContent = 
              fromDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
          } else {
            const fromStr = fromDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
            const toStr = toDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            document.getElementById('preview-date').textContent = `${fromStr} - ${toStr}`;
          }
        }
        
        // 更新行程預覽
        const schedulePreview = document.getElementById('schedule-preview');
        if (appSettings.schedule.length > 0) {
          schedulePreview.innerHTML = appSettings.schedule.map(item => 
            `<div class="schedule-item">
              <span class="time">${item.time}</span>
              <span class="activity">${item.activity}</span>
            </div>`
          ).join('');
        } else {
          schedulePreview.innerHTML = '<div class="empty-state">No Schedule yet</div>';
        }
      }

      function publishChanges() {
        // 這裡會保存到 Firebase 並生成連結
        showNotification('變更已發布！');
        console.log('發布設定:', appSettings);
      }

      function copyUserLink() {
        const userLink = `${window.location.origin}?room=${roomId}`;
        navigator.clipboard.writeText(userLink).then(() => {
          showNotification('用戶連結已複製');
        });
      }

      function copyAdminLink() {
        const adminLink = `${window.location.origin}/admin.html?room=${roomId}`;
        navigator.clipboard.writeText(adminLink).then(() => {
          showNotification('管理連結已複製');
        });
      }

      function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #4CAF50;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          z-index: 1000;
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.remove();
        }, 3000);
      }
    </script>
  </body>
</html>
